<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Borzo Integration Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="borzo-integration.js"></script>
    <style>
        .test-pass { @apply bg-green-100 text-green-800 border-green-200; }
        .test-fail { @apply bg-red-100 text-red-800 border-red-200; }
        .test-pending { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
    </style>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">ðŸ§ª Borzo Integration Test Suite</h1>
        
        <!-- Test Controls -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Test Controls</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="runAllTests()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    Run All Tests
                </button>
                <button onclick="testBorzoAPI()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    Test Borzo API
                </button>
                <button onclick="testDatabase()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                    Test Database
                </button>
            </div>
        </div>

        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div id="testResults" class="space-y-4">
                <!-- Test results will be populated here -->
            </div>
        </div>

        <!-- Test Order Form -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h2 class="text-xl font-semibold mb-4">Test Order Creation</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Order Number</label>
                    <input type="text" id="testOrderNumber" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="HB-20241201-0001">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Customer Name</label>
                    <input type="text" id="testCustomerName" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Test Customer">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                    <input type="text" id="testPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="+919876543210">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <input type="text" id="testAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Test Address, Mumbai">
                </div>
            </div>
            <button onclick="createTestOrder()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                Create Test Order
            </button>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://awnmurxunaenwzluhwge.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3bm11cnh1bmFlbnd6bHVod2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNzQyNjIsImV4cCI6MjA3MjY1MDI2Mn0.vgf0wzw8DmDAMUhPPxufVaHfkl5T2trnPqzF6ZHwIJ4';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Test results storage
        let testResults = [];

        // Add test result
        function addTestResult(testName, status, message, details = '') {
            const result = {
                name: testName,
                status: status, // 'pass', 'fail', 'pending'
                message: message,
                details: details,
                timestamp: new Date().toLocaleTimeString()
            };
            testResults.push(result);
            updateTestDisplay();
        }

        // Update test display
        function updateTestDisplay() {
            const container = document.getElementById('testResults');
            container.innerHTML = testResults.map(result => `
                <div class="border rounded-lg p-4 ${result.status === 'pass' ? 'test-pass' : result.status === 'fail' ? 'test-fail' : 'test-pending'}">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold">${result.name}</h3>
                            <p class="text-sm mt-1">${result.message}</p>
                            ${result.details ? `<p class="text-xs mt-2 opacity-75">${result.details}</p>` : ''}
                        </div>
                        <span class="text-sm">${result.timestamp}</span>
                    </div>
                </div>
            `).join('');
        }

        // Test Borzo API connection
        async function testBorzoAPI() {
            addTestResult('Borzo API Connection', 'pending', 'Testing API connection...');
            
            try {
                const borzoIntegration = new BorzoIntegration();
                
                // Test with sample data
                const testOrder = {
                    order_number: 'TEST-' + Date.now(),
                    customer_first_name: 'Test',
                    customer_last_name: 'Customer'
                };
                
                const testAddress = {
                    line1: 'Test Address',
                    city: 'Mumbai',
                    state: 'Maharashtra',
                    pincode: '400001',
                    firstName: 'Test',
                    lastName: 'Customer',
                    phone: '+919876543210'
                };

                const result = await borzoIntegration.createDeliveryRequest(testOrder, testAddress);
                
                if (result.success) {
                    addTestResult('Borzo API Connection', 'pass', 'API connection successful', `Order ID: ${result.borzoOrderId}`);
                } else {
                    addTestResult('Borzo API Connection', 'fail', 'API connection failed', result.error);
                }
            } catch (error) {
                addTestResult('Borzo API Connection', 'fail', 'API connection error', error.message);
            }
        }

        // Test database connection and fields
        async function testDatabase() {
            addTestResult('Database Connection', 'pending', 'Testing database connection...');
            
            try {
                // Test basic connection
                const { data, error } = await supabase
                    .from('orders')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    addTestResult('Database Connection', 'fail', 'Database connection failed', error.message);
                    return;
                }
                
                addTestResult('Database Connection', 'pass', 'Database connection successful');
                
                // Test Borzo fields
                addTestResult('Borzo Fields Check', 'pending', 'Checking if Borzo fields exist...');
                
                const { data: fieldData, error: fieldError } = await supabase
                    .from('orders')
                    .select('borzo_order_id, borzo_tracking_url, borzo_status, half_ready_at')
                    .limit(1);
                
                if (fieldError) {
                    addTestResult('Borzo Fields Check', 'fail', 'Borzo fields not found', fieldError.message);
                } else {
                    addTestResult('Borzo Fields Check', 'pass', 'All Borzo fields exist in database');
                }
                
            } catch (error) {
                addTestResult('Database Connection', 'fail', 'Database test error', error.message);
            }
        }

        // Test callback URL
        async function testCallbackURL() {
            addTestResult('Callback URL', 'pending', 'Testing callback URL accessibility...');
            
            try {
                const response = await fetch('https://healthybowl.in/borzo-callback.html');
                
                if (response.ok) {
                    addTestResult('Callback URL', 'pass', 'Callback URL is accessible');
                } else {
                    addTestResult('Callback URL', 'fail', 'Callback URL not accessible', `Status: ${response.status}`);
                }
            } catch (error) {
                addTestResult('Callback URL', 'fail', 'Callback URL test failed', error.message);
            }
        }

        // Test order creation
        async function createTestOrder() {
            const orderNumber = document.getElementById('testOrderNumber').value || 'TEST-' + Date.now();
            const customerName = document.getElementById('testCustomerName').value || 'Test Customer';
            const phone = document.getElementById('testPhone').value || '+919876543210';
            const address = document.getElementById('testAddress').value || 'Test Address, Mumbai';
            
            addTestResult('Test Order Creation', 'pending', 'Creating test order...');
            
            try {
                const [firstName, ...lastNameParts] = customerName.split(' ');
                const lastName = lastNameParts.join(' ') || 'Customer';
                
                const { data, error } = await supabase
                    .from('orders')
                    .insert({
                        order_number: orderNumber,
                        customer_first_name: firstName,
                        customer_last_name: lastName,
                        customer_email: 'test@example.com',
                        customer_phone: phone,
                        billing_address: {
                            street: address,
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001'
                        },
                        status: 'pending',
                        payment_status: 'paid',
                        subtotal: 100,
                        gst_amount: 18,
                        total_amount: 118
                    })
                    .select();
                
                if (error) {
                    addTestResult('Test Order Creation', 'fail', 'Failed to create test order', error.message);
                } else {
                    addTestResult('Test Order Creation', 'pass', 'Test order created successfully', `Order ID: ${data[0].id}`);
                }
            } catch (error) {
                addTestResult('Test Order Creation', 'fail', 'Order creation error', error.message);
            }
        }

        // Run all tests
        async function runAllTests() {
            testResults = [];
            addTestResult('Test Suite', 'pending', 'Starting comprehensive test suite...');
            
            await testDatabase();
            await testBorzoAPI();
            await testCallbackURL();
            
            const passedTests = testResults.filter(r => r.status === 'pass').length;
            const totalTests = testResults.filter(r => r.status !== 'pending').length;
            
            addTestResult('Test Suite Complete', 'pass', `Tests completed: ${passedTests}/${totalTests} passed`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('Test Suite Initialized', 'pass', 'Ready to run tests');
        });
    </script>
</body>
</html>
